name: Build RM2100 Padavan-3.4
on: 
  workflow_dispatch:

# 设置仓库权限
permissions:
  contents: write

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
      
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get -y install unzip libtool-bin curl cmake gperf gawk flex bison nano xxd fakeroot \
        cpio git python3-docutils gettext automake autopoint texinfo build-essential help2man \
        pkg-config zlib1g-dev libgmp3-dev libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev wget

    - name: Prepare Source Code
      run: |
        # 1. 移动源码到标准目录 (解决私有仓库 clone 麻烦的问题)
        # 将当前 checkout 下来的代码复制到 /opt/rt-n56u
        sudo cp -r $GITHUB_WORKSPACE /opt/rt-n56u
        
        # 2. 设置环境变量 DIR
        echo "DIR=/opt/rt-n56u" >> $GITHUB_ENV
        
        # 3. 准备工具链
        cd /opt/rt-n56u/toolchain-mipsel
        sh dl_toolchain.sh
        
        # 4. 创建镜像存放目录
        mkdir -p /opt/images/

    - name: Modify Firmware (Overclock & Storage)
      env:
        MHZ: 1100  # CPU超频频率
      run: |
        cd ${{ env.DIR }}
        
        ##### RM2100 | Storage=80MB | Tmp=60MB #####
        echo "正在修改分区大小..."
        # 1. 修改内核配置：Storage 分区设为 80MB (0x5000000)
        sed -i 's/SIZ=0x0400000/SIZ=0x5000000/g' trunk/configs/boards/RM2100/kernel-3.4.x-5.0.config
        # 2. 修改 dev_init.sh：/etc/storage 空间限制设为 80M
        sed -i 's/size_etc="6M"/size_etc="80M"/g' trunk/user/scripts/dev_init.sh
        # 3. 修改 dev_init.sh：/tmp 内存临时目录限制设为 60M
        sed -i 's/size_tmp="24M"/size_tmp="60M"/g' trunk/user/scripts/dev_init.sh
        # 4. 修改 mtd_storage.sh：保存检查大小设为 80MB 的字节数
        sed -i 's/mtd_part_size=65536/mtd_part_size=83886080/g' trunk/user/scripts/mtd_storage.sh

        ##### CPU Overclock #####
        echo "正在设置CPU超频到 ${MHZ}MHz..."
        clock=`echo "obase=16 ; ibase=10 ; (((($MHZ/20)-1)*16+2))" | bc`
        # 使用相对路径，因为已经 cd 到了 DIR
        INIT_C="trunk/linux-3.4.x/arch/mips/rt2880/init.c"
        sed -i "554,555s:0xff:0x7ff:g" "$INIT_C"
        sed -i "554,556s:0xc2:0x$clock:g" "$INIT_C"
        
    - name: Custom Config & Build
      env:
        TNAME: RM2100
      run: |
        cd ${{ env.DIR }}/trunk
        
        # 复制模板
        if [ ! -f configs/templates/$TNAME.config ] ; then
            echo "configs/templates/$TNAME.config 未找到!"
            exit 1
        fi
        cp -f configs/templates/$TNAME.config .config
        
        ######################################################################
        #  配置插件开关 (y=集成, n=不集成)
        ######################################################################
        
        # 1. 先删除可能存在的冲突项
        sed -i '/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_MENTOHUST/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SSSERVER/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_DNSFORWARDER/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ADBYBY/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_FRPC/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_FRPS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_TUNSAFE/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ALIDDNS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SMARTDNS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SRELAY/d' .config
        sed -i '/CONFIG_FIRMWARE_CPU_900MHZ/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_V2RAY/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_XRAY/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_TROJAN/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SSOBFS/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ADGUARDHOME/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ZEROTIER/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_DDNSTO/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_WIREGUARD/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ALDRIVER/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_MSD_LITE/d' .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_IPERF3/d' .config
        
        # 2. 重新写入配置
        
        # 基础设置
        echo "CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y" >> .config
        echo "CONFIG_FIRMWARE_CPU_900MHZ=y" >> .config # 开启超频选项
        
        # 科学上网
        echo "CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n" >> .config # SS Plus
        echo "CONFIG_FIRMWARE_INCLUDE_V2RAY=n" >> .config      # 在线下载
        echo "CONFIG_FIRMWARE_INCLUDE_XRAY=n" >> .config       # 在线下载
        echo "CONFIG_FIRMWARE_INCLUDE_TROJAN=n" >> .config     # 在线下载
        echo "CONFIG_FIRMWARE_INCLUDE_SSOBFS=n" >> .config
        
        # 内网穿透
        echo "CONFIG_FIRMWARE_INCLUDE_FRPC=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_FRPS=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ALIDDNS=y" >> .config
        
        # DNS 与 广告
        echo "CONFIG_FIRMWARE_INCLUDE_SMARTDNS=y" >> .config
        # 注意：这里设为 n，因为你已经修改了脚本实现“在线下载版”，
        # 如果设为 y 会尝试编译 go 程序，导致编译变慢且固件变大
        echo "CONFIG_FIRMWARE_INCLUDE_ADGUARDHOME=n" >> .config 
        
        # 工具
        echo "CONFIG_FIRMWARE_INCLUDE_IPERF3=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_CURL=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_HTOP=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_NANO=y" >> .config
        
        # 关闭不用的
        echo "CONFIG_FIRMWARE_INCLUDE_MENTOHUST=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SCUTCLIENT=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_SSSERVER=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_WIREGUARD=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_ALDRIVER=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_MSD_LITE=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_CADDY=n" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_WYY=n" >> .config

        ######################################################################
        # 开始编译
        ######################################################################
        sudo ./clear_tree
        sudo ./build_firmware_modify $TNAME 0
        
        # 整理产物
        sudo mv -f images/*.trx /opt/images/
        cp -f .config /opt/images/${TNAME}.config
        
        # 设置环境变量供后续步骤使用
        echo "build_time=$(date '+%Y年%m月%d日%H:%M:%S' | jq -sRr @uri)" >> $GITHUB_ENV
        echo "tag=$(date '+%Y-%m-%d')" >> $GITHUB_ENV

    - name : Upload packages
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: MI-RM2100-Firmware
        path: /opt/images

    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
           > ### 编译时间: ${{ env.build_time }}
           > 固件基于源码直接编译，含超频与分区调整。
           
        tag_name: ${{ env.tag }}
        files: /opt/images/*
